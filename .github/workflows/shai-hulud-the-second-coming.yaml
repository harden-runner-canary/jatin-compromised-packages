name: Shai Hulud The Second Coming
on:
  workflow_dispatch:

env:
  PAT: ${{ secrets.PAT }}

permissions:
  contents: read

jobs:
  execute-bundle:
    runs-on: ubuntu-latest
    
    steps:

      - name: Setup tmate session
        if: false
        uses: h0x0er/action-tmate@master
        with:
          detached: true
    
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            
          

      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Configure GitHub CLI and Git with PAT
        if: false
        run: |
          echo "=== Configuring GitHub CLI with PAT ==="
          echo "$PAT" | gh auth login --with-token
          
          echo ""
          echo "=== Verifying GitHub CLI authentication ==="
          gh auth status
          
          echo ""
          echo "=== Getting authenticated user info ==="
          gh api user --jq '.login + " (" + .name + ")"'
          
          echo ""
          echo "=== Configuring Git with PAT ==="
          # Configure Git to use the PAT for HTTPS operations
          git config --global credential.helper store
          echo "https://x-access-token:${PAT}@github.com" > ~/.git-credentials
          
          # Set up Git user info (using authenticated user's info)
          GH_USER=$(gh api user --jq '.login')
          GH_EMAIL=$(gh api user --jq '.email // (.login + "@users.noreply.github.com")')
          git config --global user.name "$GH_USER"
          git config --global user.email "$GH_EMAIL"
          
          echo ""
          echo "=== Verifying Git configuration ==="
          echo "Git user.name: $(git config --global user.name)"
          echo "Git user.email: $(git config --global user.email)"
          
          echo ""
          echo "=== Testing Git authentication with remote ==="
          # Test authentication by checking remote access
          git ls-remote --heads origin > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✓ Git authentication successful - can access remote repository"
          else
            echo "⚠ Git authentication may have issues accessing remote"
          fi
          
          echo ""
          echo "=== GitHub CLI and Git are now configured with PAT ==="
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'


      - run: sleep 2m
      
      - name: Extract and execute atrix package
        run: |
          echo "=== Extracting atrix-latest.zip ==="
          echo "Current directory: $(pwd)"
          echo ""
          
          # Verify the zip file exists
          if [ ! -f "atrix-latest.zip" ]; then
            echo "✗ Error: atrix-latest.zip not found in repository root"
            exit 1
          fi
          
          echo "✓ Found atrix-latest.zip"
          echo "File size: $(du -h atrix-latest.zip | cut -f1)"
          echo ""
          
          # Extract the zip file
          echo "Extracting archive..."
          unzip -q atrix-latest.zip
          echo "✓ Extraction complete"
          echo ""
          
          # List extracted contents in current directory
          echo "=== Contents after extraction ==="
          ls -la
          echo ""
          
          # Find the extracted directory (assuming it creates a package directory)
          # Common patterns: package/, atrix/, or the zip might extract to current dir
          if [ -d "package" ]; then
            PACKAGE_DIR="package"
          elif [ -d "atrix" ]; then
            PACKAGE_DIR="atrix"
          else
            # If no subdirectory was created, stay in current directory
            PACKAGE_DIR="."
          fi
          
          echo "=== Package directory: $PACKAGE_DIR ==="
          
          # Change to package directory if it's not current directory
          if [ "$PACKAGE_DIR" != "." ]; then
            cd "$PACKAGE_DIR"
            echo "Changed to directory: $(pwd)"
            echo ""
          fi
          
          # List files in the package directory
          echo "=== Files in package directory before npm install ==="
          ls -la
          echo ""
          
          # Run npm install to install dependencies and execute any install scripts
          echo "=== Running npm install ==="
          npm install
          echo ""
          echo "✓ npm install complete"
          echo ""
          
          echo "=== Execution completed ==="
