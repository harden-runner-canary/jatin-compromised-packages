name: Shai Hulud – zapier-scripts-7.8.3 Malware Analysis
on:
  workflow_dispatch:

env:
  PAT: ${{ secrets.PAT }}

jobs:
  analyze-zapier-scripts:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Harden Runner – Audit ALL network traffic
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443,
            api.github.com:443,
            bun.sh:443,
            raw.githubusercontent.com:443

      - name: Checkout repository (contains the malicious .zip)
        uses: actions/checkout@v4

      - name: Show repo contents
        run: |
          echo "=== Repository root ==="
          ls -la
          find . -name "*.zip" -ls

      - name: Extract malicious package
        run: |
          unzip -o zapier-scripts-7.8.3.zip

          echo "=== Extraction done ==="
          echo "Final directory layout:"
          find malicious-package -type f | head -30

          echo ""
          echo "=== Locating the real package.json ==="
          find malicious-package -name package.json"
          find malicious-package -name package.json -type f

      - name: Confirm package.json path
        id: pkg
        run: |
          PKG_PATH=$(find malicious-package -name package.json -type f | head -n1)
          echo "Found package.json at: $PKG_PATH"
          echo "package_dir=$(dirname $PKG_PATH)" >> $GITHUB_OUTPUT
          cat $PKG_PATH | jq .

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install the malicious package from disk (triggers preinstall)
        working-directory: ${{ steps.pkg.outputs.package_dir }}
        run: |
          echo "=== NOW INSTALLING THE MALICIOUS PACKAGE ==="
          echo "Current directory: $(pwd)"
          echo "package.json name: $(jq -r '.name + "@" + .version' package.json)"
          
          # Force-run scripts (including preinstall)
          npm install --foreground-scripts --ignore-scripts=false --loglevel=verbose

          echo "=== npm install finished ==="

      - name: Post-install forensics – Did it work?
        run: |
          echo "=== FORENSICS AFTER INSTALL ==="
          
          echo "1. Was Bun downloaded and installed?"
          if command -v bun &>/dev/null; then
            echo "BUN IS NOW ON THE SYSTEM"
            bun --version
            which bun
            ls -la ~/.bun/bin/ || echo "No ~/.bun/bin"
          else
            echo "No bun found in PATH"
          fi

          echo ""
          echo "2. Background processes"
          ps aux | grep -E "(bun|node|zapier)" | grep -v grep || echo "None"

          echo ""
          echo "3. Recent files in /tmp"
          find /tmp -type f -mmin -10 -ls 2>/dev/null | tail -15 || echo "Nothing"

          echo ""
          echo "4. Home directory changes"
          ls -la ~/ | grep -E "(bun|.npm)" || echo "Nothing suspicious"

          echo ""
          echo "5. Critical – Check StepSecurity → Network Egress tab for:"
          echo "   • GET bun.sh/install"
          echo "   • PUT api.github.com/repos/.../contents/environment.json"
          echo "   • PUT secrets.json / env-dump.json"
          echo ""
          echo "If you see those PUT requests → the malware successfully exfiltrated secrets using your PAT"

      - name: Final warning
        if: always()
        run: |
          echo ""
          echo "ANALYSIS COMPLETE"
          echo "Go to the workflow run → Security tab → Network Egress"
          echo "You will likely see real exfiltration attempts to GitHub repos using your token."
