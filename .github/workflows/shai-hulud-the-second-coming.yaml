name: Shai Hulud – Malicious Package Sandbox
on:
  workflow_dispatch:

env:
  PAT: ${{ secrets.PAT }}

jobs:
  analyze-malicious-package:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. Harden runner + audit ALL outbound traffic (critical for catching exfil)
      - name: Harden Runner – Audit all egress
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443,
            api.github.com:443,
            objects.githubusercontent.com:443,
            bun.sh:443,
            raw.githubusercontent.com:443

      # 2. Checkout your repo (where the .zip is stored)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 3. Debug: Show what's actually in the repo root
      - name: List repository root contents
        run: |
          echo "=== Repository root contents ==="
          ls -la
          echo ""
          echo "=== Looking for zip file ==="
          find . -name "*.zip" -ls

      # 4. Extract the malicious package
      - name: Extract zapier-scripts-7.8.3.zip
        run: |
          echo "=== Extracting malicious package ==="
          unzip -o zapier-scripts-7.8.3.zip -d malicious-package
          
          echo "=== Extraction complete. Directory structure ==="
          tree malicious-package || find malicious-package -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'
          
          echo "=== Checking for package.json ==="
          if [ -f malicious-package/package.json ]; then
            echo "package.json found!"
            cat malicious-package/package.json
          else
            echo "ERROR: package.json not found in root of extracted archive"
            find malicious-package -name "package.json" -type f
            exit 1
          fi

      # 5. Set up Node.js
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 6. Create isolated project directory
      - name: Create clean npm project sandbox
        run: |
          mkdir sandbox && cd sandbox
          npm init -y > /dev/null
          echo "=== Created isolated sandbox directory ==="
          pwd
          ls -la ../malicious-package

      # 7. Install the malicious package locally from extracted folder
      - name: Install malicious package (trigger preinstall)
        working-directory: sandbox
        run: |
          echo "=== Installing malicious package from local path ==="
          npm install ../malicious-package --foreground-scripts --ignore-scripts=false
          
          echo "=== npm install completed ==="
          echo "Contents after install:"
          ls -la
          
          echo ""
          echo "=== Checking if Bun was installed ==="
          if command -v bun >/dev/null 2>&1; then
            echo "BUN INSTALLED!"
            bun --version
            which bun
          else
            echo "No bun in PATH (yet)"
          fi

      # 8. Deep post-install observation
      - name: Post-install forensics & behavior observation
        run: |
          echo "=== POST-INSTALL FORENSICS ==="
          
          echo "1. Home directory changes (looking for ~/.bun)"
          ls -la ~/
          ls -la ~/.bun 2>/dev/null || echo "No ~/.bun directory"
          
          echo ""
          echo "2. Bun binaries"
          find /home/runner -name "bun" -type f -executable 2>/dev/null || echo "No bun found"
          
          echo ""
          echo "3. Background processes (bun/node/npm)"
          ps aux | grep -E "(bun|node|npm|zapier)" | grep -v grep || echo "No suspicious processes"
          
          echo ""
          echo "4. Recent files in /tmp and current dir"
          find /tmp -type f -mmin -5 -ls 2>/dev/null | tail -20 || echo "No recent /tmp files"
          find . -type f -mmin -5 -ls 2>/dev/null || echo "No recent files"
          
          echo ""
          echo "5. Network connections (live)"
          ss -tulp | grep -E "(node|bun)" || echo "No active connections"
          
          echo ""
          echo "6. GitHub activity check (last 2 minutes)"
          gh api notifications --all --since "$(date -u -d '2 minutes ago' '+%Y-%m-%dT%H:%M:%SZ')" || echo "No recent notifications"
          
          echo ""
          echo "IMPORTANT:"
          echo "Check StepSecurity 'Network Egress' tab for:"
          echo "  • Requests to bun.sh"
          echo "  • PUT requests to api.github.com/repos/.../contents/"
          echo "  • Files like secrets.json, environment.json being uploaded"
          echo ""
          echo "Sandbox execution complete. Malware behavior should now be visible."

      # 9. Optional: Keep runner alive for manual inspection (uncomment if needed)
      # - name: Keep alive for debugging (5 minutes)
      #   if: ${{ false }}
      #   run: sleep 300
